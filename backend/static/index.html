<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Visualiza√ß√£o ORCID</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            max-width: 800px;
        }
        input, button {
            padding: 8px;
            margin: 5px 5px 5px 0;
        }
        .section {
            margin-top: 20px;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            white-space: pre-wrap;
            border-radius: 5px;
        }
        h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Consulta ORCID</h1>

    <label for="orcidInput">ORCID ID:</label>
    <input type="text" id="orcidInput" placeholder="0000-0003-1574-0784">
    <button onclick="buscar()">Buscar tudo</button>

    <div style="margin-top:10px;">
        <label for="keywordInput">Palavra-chave:</label>
        <input type="text" id="keywordInput" placeholder="ex: AI">
        <button onclick="filtrarPorPalavraChave()">Filtrar por t√≠tulo</button>

        <label for="anoInput">Ano:</label>
        <input type="number" id="anoInput" placeholder="ex: 2021">
        <button onclick="filtrarPorAno()">Filtrar por ano</button>

        <button onclick="filtrarPorCitacoes()">Filtrar por cita√ß√µes</button>
    </div>

    <div id="resultado" style="display:none;">
        <div class="section">
            <h2>Nome</h2>
            <p id="nome"></p>
        </div>

        <div class="section">
            <h2>Biografia</h2>
            <p id="biografia"></p>
        </div>

        <div class="section">
            <h2>Palavras-chave</h2>
            <ul id="keywords"></ul>
        </div>

        <div class="section">
            <h2>Empregos</h2>
            <pre id="empregos"></pre>
        </div>

        <div class="section">
            <h2>Educa√ß√£o</h2>
            <pre id="educacao"></pre>
        </div>

        <div class="section">
            <h2>Obras</h2>
            <pre id="obras"></pre>
        </div>
    </div>

    <script>
        async function buscar() {
            const orcid = getOrcid();
            if (!orcid) return;

            try {
                const res = await fetch(`http://localhost:8000/orcid/${orcid}/all`);
                if (!res.ok) throw new Error("Erro ao buscar dados");
                const data = await res.json();
                mostrarDadosCompletos(data);
            } catch (err) {
                alert("Erro ao buscar dados completos.");
                console.error(err);
            }
        }

        async function filtrarPorPalavraChave() {
            const orcid = getOrcid();
            const keyword = document.getElementById("keywordInput").value.trim();
            if (!orcid || !keyword) return alert("Digite ORCID e palavra-chave");

            try {
                const res = await fetch(`http://localhost:8000/orcid/${orcid}/works/filter_by_keyword?keyword=${encodeURIComponent(keyword)}`);
                const data = await res.json();
                mostrarObras(data.works);
            } catch (err) {
                alert("Erro ao filtrar por palavra-chave.");
                console.error(err);
            }
        }

        async function filtrarPorAno() {
            const orcid = getOrcid();
            const ano = document.getElementById("anoInput").value.trim();
            if (!orcid || !ano) return alert("Digite ORCID e ano");

            try {
                const res = await fetch(`http://localhost:8000/orcid/${orcid}/works/filter_by_year?year=${ano}`);
                const data = await res.json();
                mostrarObras(data.works);
            } catch (err) {
                alert("Erro ao filtrar por ano.");
                console.error(err);
            }
        }

        async function filtrarPorCitacoes() {
            const orcid = getOrcid();
            if (!orcid) return;

            try {
                const res = await fetch(`http://localhost:8000/orcid/${orcid}/works/filter_by_citations`);
                const data = await res.json();
                mostrarObras(data.works);
            } catch (err) {
                alert("Erro ao filtrar por cita√ß√µes.");
                console.error(err);
            }
        }

        function mostrarDadosCompletos(data) {
            document.getElementById("resultado").style.display = "block";

            const nome = data.name?.["given-names"]?.value + " " + data.name?.["family-name"]?.value;
            document.getElementById("nome").innerText = nome || "N√£o encontrado";

            document.getElementById("biografia").innerText = data.personal?.biography || "Sem biografia";

            const kwList = document.getElementById("keywords");
            kwList.innerHTML = "";
            (data.keywords || []).forEach(kw => {
                const li = document.createElement("li");
                li.textContent = kw;
                kwList.appendChild(li);
            });

            document.getElementById("empregos").innerText = formatarLista(data.employments);
            document.getElementById("educacao").innerText = formatarLista(data.educations);

            mostrarObras(data.works);
        }

        function mostrarObras(works) {
            const obrasFormatadas = (works || []).map(w =>
                `üìò ${w.title} (${w.year})\nTipo: ${w.type || "N/A"}\nDOI: ${w.doi || "N/A"}\nURL: ${w.url || "N/A"}\nCita√ß√µes: ${w.citations ?? "?"}`
            ).join("\n\n");
            document.getElementById("obras").innerText = obrasFormatadas || "Nenhuma obra encontrada.";
        }

        function formatarLista(lista) {
            return (lista || []).map(item => {
                return Object.entries(item)
                    .map(([k, v]) => `${k}: ${v || "N/A"}`)
                    .join("\n");
            }).join("\n\n");
        }

        function getOrcid() {
            const orcid = document.getElementById("orcidInput").value.trim();
            if (!orcid) {
                alert("Digite um ORCID ID v√°lido");
                return null;
            }
            return orcid;
        }
    </script>
</body>
</html>
